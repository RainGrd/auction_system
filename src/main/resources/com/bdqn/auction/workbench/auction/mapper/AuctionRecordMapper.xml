<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bdqn.auction.workbench.auction.mapper.AuctionRecordMapper">
    <resultMap id="AuctionRecordResultMap" type="auctionRecord">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        <id column="id" property="id" jdbcType="CHAR"/>
        <!--    <result column="user_id" property="userId" jdbcType="CHAR" />-->
        <!--    <result column="auction_id" property="auctionId" jdbcType="CHAR" />-->
        <result column="auction_time" property="auctionTime" jdbcType="TIMESTAMP"/>
        <result column="auction_price" property="auctionPrice" jdbcType="DECIMAL"/>
        <association property="auction" javaType="auction" column="auction_id"
                     select="com.bdqn.auction.workbench.auction.mapper.AuctionMapper.selectAuctionById"/>

        <association property="auctionUser" javaType="auctionUser" column="user_id"
                     select="com.bdqn.auction.settings.mapper.AuctionUserMapper.selectAuctionUserByAuctionUserId">
        </association>
    </resultMap>
    <sql id="AuctionRecord_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        id, user_id, auction_id, auction_time, auction_price
    </sql>
    <select id="selectByPrimaryKey" resultMap="AuctionRecordResultMap" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        select
        <include refid="AuctionRecord_Column_List"/>
        from t_auction_record
        where id = #{id,jdbcType=CHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        delete from t_auction_record
        where id = #{id,jdbcType=CHAR}
    </delete>
    <insert id="insert" parameterType="auctionRecord">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        insert into t_auction_record (id, user_id, auction_id,
        auction_time, auction_price)
        values (#{id,jdbcType=CHAR}, #{userId,jdbcType=CHAR}, #{auctionId,jdbcType=CHAR},
        #{auctionTime,jdbcType=TIMESTAMP}, #{auctionPrice,jdbcType=DECIMAL})
    </insert>
    <insert id="insertSelective" parameterType="auctionRecord">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        insert into t_auction_record
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="auctionId != null">
                auction_id,
            </if>
            <if test="auctionTime != null">
                auction_time,
            </if>
            <if test="auctionPrice != null">
                auction_price,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=CHAR},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=CHAR},
            </if>
            <if test="auctionId != null">
                #{auctionId,jdbcType=CHAR},
            </if>
            <if test="auctionTime != null">
                #{auctionTime,jdbcType=TIMESTAMP},
            </if>
            <if test="auctionPrice != null">
                #{auctionPrice,jdbcType=DECIMAL},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="auctionRecord">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        update t_auction_record
        <set>
            <if test="userId != null">
                user_id = #{userId,jdbcType=CHAR},
            </if>
            <if test="auctionId != null">
                auction_id = #{auctionId,jdbcType=CHAR},
            </if>
            <if test="auctionTime != null">
                auction_time = #{auctionTime,jdbcType=TIMESTAMP},
            </if>
            <if test="auctionPrice != null">
                auction_price = #{auctionPrice,jdbcType=DECIMAL},
            </if>
        </set>
        where id = #{id,jdbcType=CHAR}
    </update>
    <update id="updateByPrimaryKey" parameterType="auctionRecord">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Sep 21 20:09:32 CST 2022.
        -->
        update t_auction_record
        set user_id = #{userId,jdbcType=CHAR},
        auction_id = #{auctionId,jdbcType=CHAR},
        auction_time = #{auctionTime,jdbcType=TIMESTAMP},
        auction_price = #{auctionPrice,jdbcType=DECIMAL}
        where id = #{id,jdbcType=CHAR}
    </update>

    <select id="selectAuctionRecordListByAuctionId" parameterType="string"
            resultMap="AuctionRecordResultMap">
        select
        <include refid="AuctionRecord_Column_List">
        </include>
        from t_auction_record auc where auc.auction_id=#{auctionId,jdbcType=VARCHAR}
    </select>

    <insert id="insertAuctionRecord" parameterType="auctionRecord">
        insert into t_auction_record (id, user_id, auction_id, auction_price)
        VALUES ( #{auctionRecord.id,jdbcType=VARCHAR}, #{auctionRecord.auctionUser.userId,jdbcType=VARCHAR}
               , #{auctionRecord.auction.auctionId,jdbcType=VARCHAR}
               , #{auctionRecord.auctionPrice,jdbcType=DECIMAL})
    </insert>

    <select id="selectAuctionRecordByUserId"
            resultMap="AuctionRecordResultMap" parameterType="string">
        select *
        from t_auction_record
        where user_id = #{userId,jdbcType=VARCHAR};
    </select>

    <select id="selectAuctionRecordByAuctionId" resultMap="AuctionRecordResultMap" parameterType="string">
        select ta.id,
               ta.auction_id,
               ta.user_id,
               ta.auction_price
        from t_auction_record ta
                 join t_auction au on au.auction_id = ta.auction_id
        where ta.auction_id = #{auctionId,jdbcType=VARCHAR}
          and ta.auction_time &lt; au.auction_end_time
          and ta.auction_price = (select max(auction_price) from t_auction_record where auction_id = ta.auction_id)
        group by ta.user_id;
    </select>
    <select id="selectAuctionRecordByAuctionIdAndEndTime" resultMap="AuctionRecordResultMap">
        select ta.id,
               au.auction_id,
               user.user_id
        from t_auction_record ta
                 join t_auction au on au.auction_id = ta.auction_id
                 join t_auction_user user on user.user_id = ta.user_id
        where ta.auction_id = #{auctionId,jdbcType=VARCHAR}
          and ta.auction_time &lt; au.auction_end_time
        group by ta.auction_id;
    </select>
    <select id="selectAuctionRecordUserByEndTime"
            resultMap="AuctionRecordResultMap">
        select au.auction_id, tar.user_id, tar.auction_price, user1.user_name
        from t_auction_record tar
                 join t_auction au on au.auction_id = tar.auction_id
                 join t_auction_user user1 on user1.user_id = tar.user_id
        where au.auction_end_time > tar.auction_time
        order by tar.auction_time desc
    </select>
</mapper>